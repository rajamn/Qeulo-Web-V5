{% extends "base_sidebar.html" %}
{% block title %}{% if is_edit %}Edit Bill{% else %}New Bill{% endif %}{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* Page polish */
.card { border: 0; box-shadow: 0 6px 18px rgba(0,0,0,.08); border-radius: 14px; }
.card-header { font-weight: 600; background: linear-gradient(180deg,#fff, #fafafa); }
#txTable thead th { position: sticky; top: 0; z-index: 5; background: #f8f9fa; }
#txTable tbody tr:hover { background: #fcfcff; }
.btn-link.text-danger { opacity: .75; }
.btn-link.text-danger:hover { opacity: 1; }

.card-footer { background: #fff; }
#subtotal, #grandTotal { font-variant-numeric: tabular-nums; font-size: 1.15rem; }
#grandTotal { font-weight: 800; }

#patientWrap .list-group { border-radius: 12px; overflow: hidden; }
#patientWrap .list-group-item { padding: .55rem .8rem; }
</style>

<div class="container mt-4">
  <form method="post" id="billForm"
      action="{% if is_edit %}{% url 'billing:edit' master.pk %}{% else %}{% url 'billing:new' %}{% endif %}">
    {% csrf_token %}
    {{ formset.management_form }}

  

  <h3 class="mb-3"><i class="bi bi-receipt"></i> {% if is_edit %}Edit Bill{% else %}New Bill{% endif %}</h3>

    <div class="mt-3 d-flex gap-2 flex-wrap">
      <button class="btn btn-success" type="submit" name="action" value="save">
        {% if is_edit %}Update{% else %}Save{% endif %}
      </button>
      <button class="btn btn-primary" type="submit" name="action" value="print">
        {% if is_edit %}Update & Print{% else %}Save & Print{% endif %}
      </button>
    </div>

    <div class="row g-3 align-items-end mt-2">
      <div class="col-md-3">
        <label class="form-label">Date</label>
        {{ form.paid_on }}
      </div>

      <div class="col-md-5" id="patientWrap">
        <label class="form-label">Patient</label>
        <div class="input-group">
          <input id="patientSearch" type="text" class="form-control"
                 placeholder="Search name or mobileâ€¦" autocomplete="off"
                 value="{{ selected_patient_display|default:'' }}">
          <button class="btn btn-outline-secondary" type="button" id="clearPatient">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div id="patientResults" class="list-group position-absolute w-100 shadow-sm d-none"
             style="z-index: 1000; max-height: 260px; overflow:auto;"></div>

        {% if master %}
          <div class="form-text mt-1 text-muted">
            <strong>{{ master.patient.patient_name }}</strong>
            {% if master.mobile_num %} ({{ master.mobile_num }}){% endif %}
          </div>
        {% endif %}

        <input type="hidden" name="patient" id="patientId" value="{{ selected_patient_id|default:'' }}">
      </div>
    </div>
<!-- Patient Details (Collapsible) -->
<div class="card mt-3 shadow-sm border-0">
  <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
    <span><i class="bi bi-person-vcard me-1"></i> Patient Details</span>
    <button class="btn btn-sm btn-outline-primary" type="button" 
            data-bs-toggle="collapse" data-bs-target="#patientDetails"
            aria-expanded="false" aria-controls="patientDetails">
      Toggle
    </button>
  </div>

  <div id="patientDetails" class="collapse">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Mobile Number</label>
          <input type="text" name="mobile_num" class="form-control" maxlength="10" required
                value="{% if is_edit %}{{ master.mobile_num|default:'' }}{% endif %}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Patient Name</label>
          <input type="text" name="patient_name" class="form-control" required
                value="{% if is_edit %}{{ master.patient.patient_name|default:'' }}{% endif %}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Age (Years)</label>
          <input type="number" name="age_years" class="form-control"
                value="{% if is_edit %}{{ master.patient.age_years|default:'' }}{% endif %}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Age (Months)</label>
          <input type="number" name="age_months" class="form-control"
                value="{% if is_edit %}{{ master.patient.age_months|default:'' }}{% endif %}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Gender</label>
          <select name="gender" class="form-select">
            <option value="M" {% if is_edit and master.patient.gender == 'M' %}selected{% endif %}>Male</option>
            <option value="F" {% if is_edit and master.patient.gender == 'F' %}selected{% endif %}>Female</option>
            <option value="O" {% if is_edit and master.patient.gender == 'O' %}selected{% else %}selected{% endif %}>Other</option>
          </select>
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label">Referred By</label>
        <input type="text" name="referred_by" class="form-control"
               value="{{ master.patient.referred_by|default:'' }}">
      </div>
    </div>
  </div>
</div>

    <div class="card mt-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Transactions</span>
        <button id="addRow" type="button" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-plus-lg"></i> Add line
        </button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0" id="txTable">
            <thead class="table-light">
              <tr>
                <th style="width: 26%">Doctor</th>
                <th style="width: 38%">Service</th>
                <th style="width: 16%">Pay Type</th>
                <th class="text-end" style="width: 16%">Amount</th>
                <th style="width: 4%"></th>
              </tr>
            </thead>
            <tbody id="txBody">
              {% for f in formset.forms %}
              <tr class="tx-row">
                {{ f.id }}  <!-- âœ… Hidden field for instance ID -->
                <td>{{ f.doctor }}</td>
                <td>{{ f.service }}</td>
                <td>{{ f.pay_type }}</td>
                <td class="text-end">{{ f.amount }}</td>
                <td class="text-center">
                  {% if formset.can_delete %}
                    <div class="d-none">{{ f.DELETE }}</div>
                  {% endif %}
                  <button type="button" class="btn btn-link text-danger p-0 remove-row" title="Remove">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}

            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer d-flex justify-content-end gap-4">
        <div>Subtotal: <strong><span id="subtotal">0.00</span></strong></div>
        <div>Total: <strong><span id="grandTotal">0.00</span></strong></div>
      </div>
    </div>
  </form>
</div>

<script>
/* ============================================================
   ðŸ§  PATIENT SEARCH (for dropdown list)
============================================================ */
const $search  = document.getElementById("patientSearch");
const $results = document.getElementById("patientResults");
const $pid     = document.getElementById("patientId");

function clearResults() {
  $results.innerHTML = "";
  $results.classList.add("d-none");
}

function selectPatient(p) {
  $pid.value = p.id;
  $search.value = p.name + (p.mobile ? " (" + p.mobile + ")" : "");
  clearResults();

  document.querySelector('input[name="mobile_num"]').value  = p.mobile || "";
  document.querySelector('input[name="patient_name"]').value = p.name || "";
  document.querySelector('input[name="age_years"]').value   = p.age_years || "";
  document.querySelector('input[name="age_months"]').value  = p.age_months || "";
  document.querySelector('select[name="gender"]').value     = p.gender || "O";
  document.querySelector('input[name="referred_by"]').value = p.referred_by || "";
}

async function fetchPatients(q) {
  const url = "{% url 'billing:patient_search' %}?q=" + encodeURIComponent(q);
  try {
    const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
    if (!res.ok) return { results: [] };
    return await res.json();
  } catch (err) {
    console.error("Patient search error:", err);
    return { results: [] };
  }
}

function renderResults(list) {
  clearResults();
  list.forEach(p => {
    const a = document.createElement("a");
    a.href = "javascript:void(0)";
    a.className = "list-group-item list-group-item-action";
    a.textContent = p.name + (p.mobile ? " (" + p.mobile + ")" : "");
    a.onclick = () => selectPatient(p);
    $results.appendChild(a);
  });
  if (list.length) $results.classList.remove("d-none");
}

if ($search) {
  $search.addEventListener("input", () => {
    const raw = $search.value.trim();
    if (raw.length < 3) { clearResults(); return; }
    fetchPatients(raw).then(data => renderResults(data.results || []));
  });
}

document.addEventListener("click", e => {
  if (!$results.contains(e.target) && e.target !== $search) clearResults();
});


/* ============================================================
   ðŸ“± MOBILE NUMBER AUTO-FILL
============================================================ */
const mobileInput = document.querySelector('input[name="mobile_num"]');
if (mobileInput) {
  mobileInput.addEventListener("blur", async () => {
    const mobile = mobileInput.value.trim();
    if (mobile.length !== 10) return;

    try {
      const url = "{% url 'billing:patient_lookup' %}?mobile=" + encodeURIComponent(mobile);
      const res = await fetch(url);
      if (!res.ok) throw new Error("Network error");

      const data = await res.json();
      const nameField = document.querySelector('input[name="patient_name"]');
      const yearsField = document.querySelector('input[name="age_years"]');
      const monthsField = document.querySelector('input[name="age_months"]');
      const genderField = document.querySelector('select[name="gender"]');
      const refField = document.querySelector('input[name="referred_by"]');

      if (data.found) {
        // âœ… Auto-fill existing patient
        nameField.value = data.name || "";
        yearsField.value = data.age_years || "";
        monthsField.value = data.age_months || "";
        genderField.value = data.gender || "O";
        refField.value = data.referred_by || "";
        document.getElementById("patientId").value = data.id;
      } else {
        // ðŸ§¹ Clear fields for new registration
        nameField.value = "";
        yearsField.value = "";
        monthsField.value = "";
        genderField.value = "O";
        refField.value = "";
        document.getElementById("patientId").value = "";
      }
    } catch (err) {
      console.error("Patient lookup failed:", err);
    }
  });
}


/* ============================================================
   ðŸ’° SERVICE FEES + TOTALS
============================================================ */
let SERVICE_CACHE = null;

async function loadServices() {
  if (SERVICE_CACHE) return SERVICE_CACHE;
  const res = await fetch("{% url 'billing:services_api' %}");
  const json = await res.json();
  SERVICE_CACHE = {};
  json.results.forEach(s => SERVICE_CACHE[s.id] = s.fees);
  return SERVICE_CACHE;
}

function recalc() {
  let sum = 0;
  document.querySelectorAll('input[name$="-amount"]').forEach(i => {
    const v = parseFloat(i.value || "0");
    if (!isNaN(v)) sum += v;
  });
  document.getElementById("subtotal").textContent = sum.toFixed(2);
  document.getElementById("grandTotal").textContent = sum.toFixed(2);
}

document.addEventListener("input", e => {
  if (e.target.name && e.target.name.endsWith("-amount")) recalc();
});

document.addEventListener("change", async e => {
  if (e.target.name && e.target.name.endsWith("-service")) {
    const fees = await loadServices();
    const amt = e.target.closest("tr").querySelector('input[name$="-amount"]');
    if (amt) {
      amt.value = fees[e.target.value] || 0;
      recalc();
    }
  }
});


/* ============================================================
   âž• ADD / âŒ REMOVE TRANSACTION ROWS
============================================================ */
document.addEventListener("click", e => {
  if (e.target.id === "addRow") {
    const mgmtTotal = document.getElementById("id_transactions-TOTAL_FORMS");
    const idx = parseInt(mgmtTotal.value, 10);
    const tmpl = document.querySelector(".tx-row").cloneNode(true);

    tmpl.querySelectorAll("input,select").forEach(el => {
      el.name = el.name.replace(/transactions-\d+-/g, `transactions-${idx}-`);
      el.id   = el.id.replace(/transactions-\d+-/g, `transactions-${idx}-`);
      if (el.matches('input[name$="-DELETE"]')) el.checked = false;
      else if (el.tagName === "INPUT") el.value = "";
      else if (el.tagName === "SELECT") el.selectedIndex = 0;
    });

    document.getElementById("txBody").appendChild(tmpl);
    mgmtTotal.value = idx + 1;
  }

  const removeBtn = e.target.closest(".remove-row");
  if (removeBtn) {
    const row = removeBtn.closest("tr");
    const del = row.querySelector('input[name$="-DELETE"]');
    if (del) { del.checked = true; row.style.display = "none"; }
    recalc();
  }
});

recalc();
</script>
{% endblock %}
