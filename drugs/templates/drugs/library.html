{% extends "base_sidebar.html" %}

{% block title %}Drug Library{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Drug Library</h2>
  <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-3">

    <!-- Link to edit your library -->
    <a href="{% url 'drug_library_edit' %}" class="btn btn-outline-primary mb-3">Edit Your Library</a>

    <!-- Add New Drug button -->
    <a href="{% url 'lib_add_drug' %}?next={% url 'drug_library' %}" class="btn btn-outline-primary me-2">
      <i class="bi bi-book"></i> Add New Drug
    </a>
  </div>

  <!-- Search & filter form -->
  <form method="get" class="mb-3 d-flex flex-wrap align-items-center gap-3" role="search">

    <!-- Search input with icon -->
    <div class="input-group" style="max-width: 320px;">
      <span class="input-group-text" id="search-icon">
        <i class="bi bi-search"></i>
      </span>
      <input
        type="search"
        name="q"
        id="drug-search"
        value="{{ query }}"
        class="form-control"
        placeholder="Search drugs..."
        aria-label="Search drugs"
        aria-describedby="search-icon"
        autocomplete="off"
        spellcheck="false"
        autocorrect="off"
        autocapitalize="off"
      />
    </div>

    <!-- Checkboxes inline -->
    <div class="form-check form-check-inline">
      <input
        class="form-check-input"
        type="checkbox"
        id="showGlobal"
        name="show_global"
        value="1"
        {% if show_global %}checked{% endif %}
      >
      <label class="form-check-label" for="showGlobal">Global</label>
    </div>

    <div class="form-check form-check-inline">
      <input
        class="form-check-input"
        type="checkbox"
        id="showHospital"
        name="show_hospital"
        value="1"
        {% if show_hospital %}checked{% endif %}
      >
      <label class="form-check-label" for="showHospital">Hospital</label>
    </div>

    <div class="form-check form-check-inline">
      <input
        class="form-check-input"
        type="checkbox"
        id="showDoctor"
        name="show_doctor"
        value="1"
        {% if show_doctor %}checked{% endif %}
      >
      <label class="form-check-label" for="showDoctor">Doctor</label>
    </div>

    <!-- Filter Button -->
    <button type="submit" class="btn btn-primary">Filter</button>
  </form>

  <!-- Drug table -->
  <table id="drug-table" class="table table-hover">
    <thead>
      <tr>
        <th>Drug Name</th>
        <th>Composition</th>
        <th>Added By</th>
      </tr>
    </thead>
    <tbody>
      {% for drug in drugs %}
      <tr
        class="
          {% if drug.added_by == 'Doctor' %}table-success{% endif %}
          {% if drug.added_by == 'Hospital' %}table-primary{% endif %}
          {% if drug.added_by == 'Global' %}table-secondary{% endif %}
        "
      >
        <td>{{ drug.drug_name }}</td>
        <td>{{ drug.composition|default:"â€”" }}</td>
        <td>
          <span class="badge
            {% if drug.added_by == 'Doctor' %}bg-success
            {% elif drug.added_by == 'Hospital' %}bg-primary
            {% elif drug.added_by == 'Global' %}bg-secondary
            {% else %}bg-dark
            {% endif %}
          ">
            {{ drug.added_by }}
          </span>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="3" class="text-center">No drugs found.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Pagination controls -->
  <nav aria-label="Page navigation" class="mt-3">
    <ul class="pagination justify-content-center">
      {% if drugs.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ drugs.previous_page_number }}&q={{ query }}&show_global={{ show_global|yesno:'1,0' }}&show_hospital={{ show_hospital|yesno:'1,0' }}&show_doctor={{ show_doctor|yesno:'1,0' }}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
      {% endif %}

      {% for num in drugs.paginator.page_range %}
        {% if drugs.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num >= drugs.number|add:'-2' and num <= drugs.number|add:'2' %}
          <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ query }}&show_global={{ show_global|yesno:'1,0' }}&show_hospital={{ show_hospital|yesno:'1,0' }}&show_doctor={{ show_doctor|yesno:'1,0' }}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if drugs.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ drugs.next_page_number }}&q={{ query }}&show_global={{ show_global|yesno:'1,0' }}&show_hospital={{ show_hospital|yesno:'1,0' }}&show_doctor={{ show_doctor|yesno:'1,0' }}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
      {% endif %}
    </ul>
  </nav>

</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const searchInput = document.getElementById("drug-search");
  const showGlobal = document.getElementById("showGlobal");
  const showHospital = document.getElementById("showHospital");
  const showDoctor = document.getElementById("showDoctor");
  const tableRows = document.querySelectorAll("#drug-table tbody tr");

  function filterTable() {
    const query = searchInput.value.trim().toLowerCase();
    const g = showGlobal.checked;
    const h = showHospital.checked;
    const d = showDoctor.checked;

    tableRows.forEach(row => {
      const drugName = row.cells[0].textContent.toLowerCase();
      const addedBy = row.cells[2].textContent.trim();

      const matchesSearch = drugName.includes(query);

      const matchesCheckbox =
        (addedBy === "Global" && g) ||
        (addedBy === "Hospital" && h) ||
        (addedBy === "Doctor" && d);

      row.style.display = matchesSearch && matchesCheckbox ? "" : "none";
    });
  }

  // Live filter on typing
  searchInput.addEventListener("input", filterTable);

  // Live filter on checkbox toggle WITHOUT submitting the form
  [showGlobal, showHospital, showDoctor].forEach(cb => {
    cb.addEventListener("change", function(e) {
      e.preventDefault(); // prevent any accidental form submit
      filterTable();
    });
  });

  // Initial filter when page loads
  filterTable();
});
</script>

{% endblock %}
