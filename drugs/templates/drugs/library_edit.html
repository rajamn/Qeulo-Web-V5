{% extends "base_sidebar.html" %}

{% block title %}Edit Drug Library{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Edit Your Drug Library</h2>

  <!-- Filter/Search Form (GET) -->
  <form method="get" class="mb-3 d-flex align-items-center gap-3 flex-wrap" role="search">

    <div class="input-group" style="max-width: 320px;">
      <input
        type="search"
        name="q"
        id="drug-search"
        value="{{ query }}"
        class="form-control"
        placeholder="Search drugs..."
        aria-label="Search drugs"
        autocomplete="off"
        spellcheck="false"
        autocorrect="off"
        autocapitalize="off"
      />
      <button class="btn btn-outline-secondary" type="submit" aria-label="Submit search">
        <i class="bi bi-search"></i>
      </button>
    </div>

    <div class="form-check form-check-inline ms-3">
      <input
        class="form-check-input"
        type="checkbox"
        id="showGlobal"
        name="show_global"
        value="1"
        {% if show_global %}checked{% endif %}
      >
      <label class="form-check-label" for="showGlobal">Global</label>
    </div>

    <div class="form-check form-check-inline">
      <input
        class="form-check-input"
        type="checkbox"
        id="showHospital"
        name="show_hospital"
        value="1"
        {% if show_hospital %}checked{% endif %}
      >
      <label class="form-check-label" for="showHospital">Hospital</label>
    </div>

    <div class="form-check form-check-inline">
      <input
        class="form-check-input"
        type="checkbox"
        id="showDoctor"
        name="show_doctor"
        value="1"
        {% if show_doctor %}checked{% endif %}
      >
      <label class="form-check-label" for="showDoctor">Doctor</label>
    </div>
  </form>

  <!-- Drug Selection Form (POST) -->
  <form method="post" novalidate>
    {% csrf_token %}

    <table class="table table-hover" id="drug-table">
      <thead>
        <tr>
          <th></th> <!-- Checkbox column -->
          <th>Drug Name</th>
          <th>Composition</th>
          <th>Added By</th>
        </tr>
      </thead>
      <tbody>
        {% for drug in drugs %}
        <tr
          class="
            {% if drug.added_by == 'Doctor' %}table-success{% endif %}
            {% if drug.added_by == 'Hospital' %}table-primary{% endif %}
            {% if drug.added_by == 'Global' %}table-secondary{% endif %}
          "
        >
          <td>
            <input
              type="checkbox"
              name="selected_drugs"
              value="{{ drug.id }}"
              {% if drug.is_selected %}checked{% endif %}
              aria-label="Select {{ drug.drug_name }}"
            />
          </td>
          <td>{{ drug.drug_name }}</td>
          <td>{{ drug.composition|default:"â€”" }}</td>
          <td>
            <span class="badge
              {% if drug.added_by == 'Doctor' %}bg-success
              {% elif drug.added_by == 'Hospital' %}bg-primary
              {% elif drug.added_by == 'Global' %}bg-secondary
              {% else %}bg-dark
              {% endif %}
            ">
              {{ drug.added_by }}
            </span>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="text-center">No drugs found.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Pagination Controls -->
    <nav aria-label="Page navigation" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if drugs.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ drugs.previous_page_number }}&q={{ query }}&show_global={{ show_global|yesno:'1,0' }}&show_hospital={{ show_hospital|yesno:'1,0' }}&show_doctor={{ show_doctor|yesno:'1,0' }}" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
        {% endif %}

        {% for num in drugs.paginator.page_range %}
          {% if drugs.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% elif num >= drugs.number|add:'-2' and num <= drugs.number|add:'2' %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ query }}&show_global={{ show_global|yesno:'1,0' }}&show_hospital={{ show_hospital|yesno:'1,0' }}&show_doctor={{ show_doctor|yesno:'1,0' }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if drugs.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ drugs.next_page_number }}&q={{ query }}&show_global={{ show_global|yesno:'1,0' }}&show_hospital={{ show_hospital|yesno:'1,0' }}&show_doctor={{ show_doctor|yesno:'1,0' }}" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
        {% endif %}
      </ul>
    </nav>

    <button type="submit" class="btn btn-primary">Save Selections</button>
    <a href="{% url 'drug_library' %}" class="btn btn-secondary ms-2">Cancel</a>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const searchInput = document.getElementById("drug-search");
  const tableRows = document.querySelectorAll("#drug-table tbody tr");

  searchInput.addEventListener("input", function() {
    const query = this.value.trim().toLowerCase();
    tableRows.forEach(row => {
      const drugName = row.cells[1].textContent.toLowerCase();
      if (drugName.includes(query)) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  });
});
</script>
{% endblock %}
