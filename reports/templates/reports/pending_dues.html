{% extends "base_sidebar.html" %}
{% block title %}Pending Dues{% endblock %}

{% block content %}
<div class="container mt-4">

  <h2 class="text-danger mb-4">
    <i class="bi bi-exclamation-triangle"></i> Pending Dues
  </h2>

  <!-- Filters -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">Start Date</label>
      <input type="date" name="start" value="{{ start|date:'Y-m-d' }}" class="form-control">
    </div>

    <div class="col-md-3">
      <label class="form-label">End Date</label>
      <input type="date" name="end" value="{{ end|date:'Y-m-d' }}" class="form-control">
    </div>

    <div class="col-md-3">
      <label class="form-label">Doctor</label>
      <select name="doctor" class="form-select">
        <option value="">All</option>
        {% for d in doctors %}
        <option value="{{ d.id }}">{{ d.doctor_name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Min Due (₹)</label>
      <input type="number" name="min_due" value="{{ request.GET.min_due }}" class="form-control">
    </div>

    <div class="col-md-2">
      <button class="btn btn-danger w-100 mt-4">Filter</button>
    </div>
  </form>

  <!-- KPI Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-danger">
        <div class="card-body">
          <div class="text-muted small">Total Due</div>
          <div class="fs-4 fw-bold text-danger">₹ {{ total_due|floatformat:2 }}</div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-warning">
        <div class="card-body">
          <div class="text-muted small">Pending Bills</div>
          <div class="fs-4 fw-bold">{{ total_items }}</div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Avg Due</div>
          <div class="fs-4 fw-bold">₹ {{ avg_due|floatformat:2 }}</div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-dark">
        <div class="card-body">
          <div class="text-muted small">Largest Due</div>
          <div class="fs-4 fw-bold">₹ {{ max_due|floatformat:2 }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dues Table -->
  <div class="table-responsive card shadow-sm">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          <th>Patient</th>
          <th>Mobile</th>
          <th>Doctor</th>
          <th>Service</th>
          <th class="text-end">Due Amount</th>
        </tr>
      </thead>
      <tbody>
        {% for d in dues %}
        <tr class="{% if d.amount > 500 %}table-danger{% endif %}">
          <td>{{ d.paid_on }}</td>
          <td>{{ d.patient.patient_name }}</td>
          <td>{{ d.patient.contact.mobile_num }}</td>
          <td>{{ d.doctor.doctor_name }}</td>
          <td>{{ d.service.service_name }}</td>
          <td class="text-end fw-bold text-danger">₹ {{ d.amount }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted py-3">No pending dues.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}
