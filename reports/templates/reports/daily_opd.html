{% extends "base_sidebar.html" %}
{% block title %}Daily OPD Summary{% endblock %}

{% block content %}
<div class="container py-4">
  <h3 class="mb-4 text-primary">
    Daily OPD ‚Äì {{ report_date|date:"d M Y" }}
  </h3>
  <div class="row">

    <!-- Status Distribution (Pie) -->
    <div class="col-md-6 mb-4">
      <h5 class="text-center">OPD Status Distribution</h5>
      <div style="height: 260px;">
        <canvas id="opdStatusChart"></canvas>
      </div>
    </div>

    <!-- Revenue By Doctor (Bar) -->
    <div class="col-md-6 mb-4">
      <h5 class="text-center">Revenue by Doctor</h5>
      <div style="height: 260px;">
        <canvas id="opdRevenueChart"></canvas>
      </div>
    </div>

  </div>

  <!-- üîç Filters -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-auto">
      <label for="id_date" class="form-label mb-0">Date</label>
      <input type="date"
             id="id_date"
             name="date"
             class="form-control"
             value="{{ report_date|date:'Y-m-d' }}">
    </div>
    <div class="col-auto align-self-end">
      <button type="submit" class="btn btn-primary">
        Apply
      </button>
    </div>
  </form>

  <!-- üìä KPI Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-muted small">Total Registrations</div>
          <div class="fs-4 fw-bold">{{ total_reg }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-muted small">Completed</div>
          <div class="fs-4 fw-bold text-success">{{ total_completed }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-muted small">In Queue</div>
          <div class="fs-4 fw-bold text-warning">{{ total_queued }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-muted small">Cancelled</div>
          <div class="fs-4 fw-bold text-danger">{{ total_cancelled }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- üí∞ Revenue Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-muted small">Total Revenue Collected</div>
          <div class="fs-4 fw-bold">
            ‚Çπ {{ total_revenue|floatformat:2 }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-muted small">Outstanding Dues</div>
          <div class="fs-4 fw-bold text-danger">
            ‚Çπ {{ total_due|floatformat:2 }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- üßë‚Äç‚öïÔ∏è Revenue by Doctor -->
  {% if revenue_by_doctor %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">Revenue by Doctor</h5>
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>Doctor</th>
            <th class="text-end">Amount (‚Çπ)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in revenue_by_doctor %}
          <tr>
            <td>{{ row.doctor__doctor_name }}</td>
            <td class="text-end">{{ row.total|floatformat:2 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- üìã Detailed Appointment Table -->
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h5 class="card-title mb-3">Appointments</h5>
      <div class="table-responsive">
        <table class="table table-hover table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>Time / ETA</th>
              <th>Doctor</th>
              <th>Patient</th>
              <th>Token</th>
              <th>Queue Pos</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for appt in appointments %}
            <tr>
              <td>{{ appt.eta|default:"‚Äî" }}</td>
              <td>{{ appt.doctor.doctor_name }}</td>
              <td>{{ appt.patient.patient_name }}</td>
              <td>{{ appt.token_num }}</td>
              <td>{{ appt.que_pos }}</td>
              <td>
                {% if appt.completed == -1 %}
                  <span class="badge bg-secondary">Registered</span>
                {% elif appt.completed == 0 %}
                  <span class="badge bg-warning text-dark">In Queue</span>
                {% elif appt.completed == 1 %}
                  <span class="badge bg-success">Completed</span>
                {% elif appt.completed == 2 %}
                  <span class="badge bg-danger">Cancelled</span>
                {% else %}
                  <span class="badge bg-light text-muted">Unknown</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">
                No appointments for this date.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const data = JSON.parse(`{{ chart_data_json|escapejs }}`);

    /* =============================
       1Ô∏è‚É£ OPD Status Pie Chart
       ============================= */
    const ctxStatus = document.getElementById("opdStatusChart");
    if (ctxStatus) {
        new Chart(ctxStatus, {
            type: "doughnut",
            data: {
                labels: data.status_labels,
                datasets: [{
                    data: data.status_values,
                    backgroundColor: [
                        "rgba(108, 117, 125, 0.7)",  // Registered
                        "rgba(255, 193, 7, 0.7)",    // In Queue
                        "rgba(40, 167, 69, 0.7)",    // Completed
                        "rgba(220, 53, 69, 0.7)"     // Cancelled
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: "bottom" }
                }
            }
        });
    }

    /* =============================
       2Ô∏è‚É£ Revenue by Doctor
       ============================= */
    const ctxRevenue = document.getElementById("opdRevenueChart");
    if (ctxRevenue) {
        new Chart(ctxRevenue, {
            type: "bar",
            data: {
                labels: data.doctor_labels,
                datasets: [{
                    label: "Revenue (‚Çπ)",
                    data: data.doctor_revenue,
                    backgroundColor: "rgba(54, 162, 235, 0.6)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: "Revenue (‚Çπ)" }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

});
</script>
{% endblock %}

