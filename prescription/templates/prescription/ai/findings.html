{% extends "prescription/ai/base_ai_wizard.html" %}
{% block title %}Findings ‚Äî AI Prescription{% endblock %}

{% block step_title %}
<div class="d-flex justify-content-between align-items-center">
  <span>Step 3 ¬∑ Clinical Findings</span>

  <button type="button"
          class="btn btn-sm btn-outline-primary p-1 px-2"
          data-bs-toggle="modal"
          data-bs-target="#investigationsModal"
          title="Investigations & Vitals">
      üìë
  </button>
</div>
{% endblock %}

{% block step_subtitle %}
Document examination findings and vitals relevant to this visit.
{% endblock %}

{% block step_content %}
<form method="post" novalidate>
  {% csrf_token %}

  {% if draft.data.carried.notes_findings %}
    <div class="alert bg-light border p-3 mb-3">
      <strong>Previous Findings:</strong>
      <pre class="small">{{ draft.data.carried.notes_findings }}</pre>

      <button type="button"
              class="btn btn-sm btn-outline-primary"
              onclick="copyToTextarea('id_findings', `{{ draft.data.carried.notes_findings|escapejs }}`)">
          Copy Findings ‚Üí
      </button>
    </div>
  {% endif %}

<div class="mb-3">
    <label for="id_findings" class="form-label fw-semibold">Clinical findings</label>

    <textarea id="id_findings" name="findings" class="form-control"
              rows="8"
              placeholder="E.g. BP 130/80, PR 96/min, Temp 101¬∞F, no pallor, RS clear...">{{ findings }}</textarea>

    <div class="form-text">
      Include vitals, systemic exam findings, and key negative findings.
    </div>
  </div>

  <div class="d-flex justify-content-between mt-3">
    <a href="{% url 'prescription:ai_rx_symptoms' draft.id %}" class="btn btn-outline-secondary">
      ‚Üê Back: Symptoms
    </a>

    <button type="submit" class="btn btn-primary">Next: Diagnosis ‚Üí</button>
  </div>
</form>

<!-- ===================================================== -->
<!--  Investigations Modal (Vitals + Reports)               -->
<!-- ===================================================== -->

<div class="modal fade" id="investigationsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Investigations & Vitals</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- ------------------ -->
        <!-- VITALS SECTION      -->
        <!-- ------------------ -->
        <h5 class="mb-2">Vitals</h5>

        {% if latest_vitals %}
        <div class="card p-3 mb-4 bg-light border">

            <div class="row text-center mb-2">
                <div class="col-4">
                    <small class="text-muted d-block">Height</small>
                    <strong>{{ latest_vitals.height_cm }} cm</strong>
                </div>

                <div class="col-4">
                    <small class="text-muted d-block">Weight</small>
                    <strong>{{ latest_vitals.weight_kg }} kg</strong><br>
                    <small class="text-muted">BMI {{ latest_vitals.bmi }}</small>
                </div>

                <div class="col-4">
                    <small class="text-muted d-block">Temp</small>
                    <strong>{{ latest_vitals.temperature_c }} ¬∞C</strong>
                </div>
            </div>

            <hr class="my-2">

            <div class="row text-center">
                <div class="col-4">
                    <small class="text-muted d-block">Blood Pressure</small>
                    <strong>{{ latest_vitals.bp_systolic }}/{{ latest_vitals.bp_diastolic }}</strong>
                </div>

                <div class="col-4">
                    <small class="text-muted d-block">Pulse</small>
                    <strong>{{ latest_vitals.pulse_bpm|default:"‚Äî" }} bpm</strong>
                </div>

                <div class="col-4">
                    <small class="text-muted d-block">SpO‚ÇÇ</small>
                    <strong>{{ latest_vitals.spo2_percent }}%</strong>
                </div>
            </div>

            <div class="text-end mt-3">
                <button type="button" class="btn btn-sm btn-outline-primary" id="insertVitalsBtn">
                    Insert Vitals ‚Üí
                </button>
            </div>

        </div>

        {% else %}
        <p class="text-muted">No vitals recorded.</p>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-4" id="insertVitalsTemplateBtn">
            Insert Vitals Template ‚Üí
        </button>
        {% endif %}

        <!-- ------------------ -->
        <!-- REPORTS SECTION    -->
        <!-- ------------------ -->

        <h5 class="mt-4 mb-2">Investigation Reports</h5>

        {% if visit_docs %}
          {% for doc in visit_docs %}
          <div class="border-bottom pb-3 mb-3">

            <strong>{{ doc.get_doc_type_display }}</strong>
            <span class="text-muted small"> ¬∑ {{ doc.created_at|date:"d M Y" }}</span>

            {% if doc.description %}
            <div class="small mt-1">{{ doc.description }}</div>
            {% endif %}

            <div class="mt-2">
                {% if doc.file %}
                <a class="btn btn-sm btn-outline-primary" href="{{ doc.file.url }}"
                   target="_blank">View File ‚Üí</a>
                {% endif %}
            </div>

            <!-- AI Summary -->
            {% if doc.ai_summary_data %}
            <details class="mt-2">
                <summary class="fw-bold text-success">
                    <i class="bi bi-robot"></i> AI Summary
                </summary>

                <div class="p-2 bg-light border rounded small mt-2">
                    {% if doc.ai_summary_data.impression %}
                    <p><strong>Impression:</strong> {{ doc.ai_summary_data.impression }}</p>
                    {% endif %}

                    {% if doc.ai_summary_data.key_findings %}
                    <strong>Key Findings:</strong>
                    <ul>
                      {% for line in doc.ai_summary_data.key_findings.splitlines %}
                        {% if line %}<li>{{ line }}</li>{% endif %}
                      {% endfor %}
                    </ul>
                    {% endif %}

                    {% if doc.ai_summary_data.recommendations %}
                    <strong>Recommendations:</strong>
                    <ul>
                      {% for line in doc.ai_summary_data.recommendations.splitlines %}
                        {% if line %}<li>{{ line }}</li>{% endif %}
                      {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </details>
            {% endif %}

            {% if doc.ocr_text %}
            <details class="mt-2">
                <summary class="text-primary fw-semibold">
                    <i class="bi bi-search"></i> OCR Extracted Text
                </summary>

                <pre class="small mt-2 p-2 bg-light border rounded"
                     style="white-space: pre-wrap; max-height: 250px; overflow-y:auto;">{{ doc.ocr_text }}</pre>
            </details>
            {% endif %}

          </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">No investigation reports found.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ===================================================== -->
<!--  JS                                                   -->
<!-- ===================================================== -->

<script>
const VITALS_TEXT = `{{ vitals_block|escapejs }}`;
</script>

{% verbatim %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    const textarea = document.getElementById("id_findings");

    function insertBlock(text) {
        const existing = textarea.value.trim();
        textarea.value = existing
            ? existing + "\n\n" + text.trim() + "\n"
            : text.trim() + "\n";
        textarea.focus();
    }

    if (document.getElementById("insertVitalsBtn")) {
        document.getElementById("insertVitalsBtn").addEventListener("click", () => {
            insertBlock(VITALS_TEXT);
        });
    }

    if (document.getElementById("insertVitalsTemplateBtn")) {
        document.getElementById("insertVitalsTemplateBtn").addEventListener("click", () => {
            insertBlock(VITALS_TEXT);
        });
    }

    // Auto-save every 5 seconds
    let timer = null;
    textarea.addEventListener("input", function () {
        clearTimeout(timer);
        timer = setTimeout(() => {
            fetch("{% url 'prescription:ai_rx_autosave' draft.id %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    field: "findings",
                    value: textarea.value
                })
            });
        }, 5000);
    });

});
document.addEventListener("DOMContentLoaded", function () {
    Autosave.init();
});
</script>
<script>
document.getElementById("id_findings")
  .addEventListener("input", e => {
      Autosave.save("findings", e.target.value);
  });
</script>

{% endverbatim %}
{% endblock %}
