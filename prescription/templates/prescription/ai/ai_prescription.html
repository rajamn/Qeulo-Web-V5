{% extends "prescription/ai/base_ai_wizard.html" %}
{% block title %}AI Prescription Suggestions{% endblock %}

{% block step_title %}Step 6 · AI Prescription Suggestions{% endblock %}
{% block step_subtitle %}
AI proposes possible medicines. You review and add only what you feel is appropriate.
{% endblock %}

{% block step_content %}

<div class="mb-3 text-end">
  <a href="?refresh=1" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-repeat"></i> Refresh Drug Suggestions
  </a>
</div>

{% if ai_drugs.error %}
  <div class="alert alert-warning">
    <strong>AI drug suggestions are currently unavailable.</strong><br>
    <span class="small">{{ ai_drugs.error }}</span><br>
    You can still continue and manually adjust the prescription.
  </div>

  <div class="mt-3 text-end">
    <a href="{% url 'ai_rx_review' draft.id %}" class="btn btn-primary">
      Continue to Review →
    </a>
  </div>

{% else %}

{% if ai_drugs.drug_groups %}
  {% for group in ai_drugs.drug_groups %}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold d-flex justify-content-between">
        <span>{{ group.group_name }}</span>
        {% if group.reason %}
          <span class="small text-muted">{{ group.reason }}</span>
        {% endif %}
      </div>

      <div class="card-body p-2">

        <ul class="list-group list-group-flush">

          {% for d in group.drugs %}
          <li class="list-group-item py-3 px-2 border-0 border-bottom bg-white"
              style="transition: background-color .2s;">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">

              <!-- LEFT CONTENT -->
              <div class="me-3">
                <strong class="fs-6">{{ d.drug_name }}</strong>
                <div class="small text-muted mt-1">
                  {{ d.dosage }} • {{ d.frequency }} • {{ d.duration }}<br>
                  Food: {{ d.food_order|default:"after" }}
                </div>

                {% if d.why %}
                <div class="small text-success mt-1">
                  <i class="bi bi-info-circle"></i> {{ d.why }}
                </div>
                {% endif %}

                {% if d.caution %}
                <div class="small text-danger mt-1">
                  <i class="bi bi-exclamation-triangle"></i> {{ d.caution }}
                </div>
                {% endif %}
              </div>

              <!-- RIGHT ACTION BUTTON -->
              <div class="ms-auto text-end">
                <button type="button"
                        class="btn btn-sm btn-outline-primary add-drug-btn"
                        data-draft-id="{{ draft.id }}"
                        data-drug-name="{{ d.drug_name|escapejs }}"
                        data-dosage="{{ d.dosage|escapejs }}"
                        data-frequency="{{ d.frequency|escapejs }}"
                        data-duration="{{ d.duration|escapejs }}"
                        data-food-order="{{ d.food_order|default:''|escapejs }}">
                  <i class="bi bi-plus-circle"></i> Add
                </button>
              </div>

            </div>
          </li>
          {% endfor %}

        </ul>

      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-info">
    No AI drug suggestions received. You can still proceed to review.
  </div>
{% endif %}

<div class="d-flex justify-content-between mt-4">
  <a href="{% url 'ai_rx_ai_suggestions' draft.id %}" 
     class="btn btn-outline-secondary">
    ← Back: AI Clinical Suggestions
  </a>

  <a href="{% url 'ai_rx_review' draft.id %}"
     class="btn btn-primary">
    Continue to Review →
  </a>
</div>

{% endif %}


<!-- Script to Add Drug to Draft -->
<script>
function addDrugToDraft(draft_id, drug_data) {
  fetch(`/prescription/ai/${draft_id}/add-drug/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/json"
    },
    body: JSON.stringify(drug_data)
  }).then(res => {
    if (res.ok) {
      window.location.reload();
    } else {
      alert("Error adding drug to draft.");
    }
  }).catch(() => alert("Network error while adding drug."));
}

document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".add-drug-btn").forEach(btn => {
    btn.addEventListener("click", function () {
      const payload = {
        drug_name: this.dataset.drugName,
        dosage: this.dataset.dosage,
        frequency: this.dataset.frequency,
        duration: this.dataset.duration,
        food_order: this.dataset.foodOrder || "after"
      };
      addDrugToDraft(this.dataset.draftId, payload);
    });
  });

  // Hover highlight effect
  document.querySelectorAll(".list-group-item").forEach(item => {
    item.addEventListener("mouseenter", () => item.style.backgroundColor = "#f8f9fa");
    item.addEventListener("mouseleave", () => item.style.backgroundColor = "white");
  });
});
document.addEventListener("DOMContentLoaded", function () {
    Autosave.init();
});
</script>


{% endblock %}
