{% extends "prescription/ai/base_ai_wizard.html" %}
{% block title %}Diagnosis — AI Prescription{% endblock %}

{% block step_title %}Step 4 · Provisional Diagnosis{% endblock %}
{% block step_subtitle %}
Record your working / provisional diagnosis before seeing AI suggestions.
{% endblock %}

{% block step_content %}
<form method="post" novalidate>
  {% csrf_token %}

  {% if draft.data.carried.diagnosis %}
    <div class="alert bg-light border p-3 mb-3">
      <strong>Previous Diagnosis:</strong>
      <pre class="small">{{ draft.data.carried.diagnosis }}</pre>

      <button type="button"
              class="btn btn-sm btn-outline-primary"
              onclick="copyToTextarea('id_diagnosis', `{{ draft.data.carried.diagnosis|escapejs }}`)">
          Copy Diagnosis →
      </button>
    </div>
  {% endif %}

  <div class="mb-3">
    <label for="id_diagnosis" class="form-label fw-semibold">
      Provisional diagnosis
    </label>

    <textarea
      id="id_diagnosis"
      name="diagnosis"
      class="form-control"
      rows="5"
      placeholder="E.g. Acute viral febrile illness — ?Dengue / ?Enteric fever...">
      {{ diagnosis|default_if_none:"" }}</textarea>

    <div class="form-text">
      You can enter differentials here as well, if you prefer.
    </div>
  </div>

  <div class="d-flex justify-content-between mt-3">
    <a href="{% url 'ai_rx_findings' draft.id %}" class="btn btn-outline-secondary">
      ← Back: Findings
    </a>

    {% if draft.hospital.ai_enabled %}
      <button type="submit" class="btn btn-primary">
        Next: AI Suggestions →
      </button>
    {% else %}
      <button type="submit" class="btn btn-primary">
        Next: Prescription →
      </button>
    {% endif %}
  </div>

</form>
<script>
document.addEventListener("DOMContentLoaded", function () {
    Autosave.init();
});
document.getElementById("id_diagnosis")
  .addEventListener("input", e => {
      Autosave.save("diagnosis", e.target.value);
  });
</script>
{% endblock %}
