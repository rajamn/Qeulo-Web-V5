{% extends "prescription/ai/base_ai_wizard.html" %}
{% block title %}History ‚Äî AI Prescription{% endblock %}

{% block step_title %}
<div class="d-flex justify-content-between align-items-center">
    <span>Step 1 ¬∑ History</span>

    <button type="button"
            class="btn btn-sm btn-outline-success p-1 px-2"
            data-bs-toggle="modal"
            data-bs-target="#addHistoryTemplateModal"
            title="Add Custom Template">
        <i class="bi bi-plus-circle"></i>
    </button>
</div>
{% endblock %}

{% block step_subtitle %}
Briefly capture the patient‚Äôs history in your own words.
{% endblock %}


{% block step_content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.css">
<style>.ts-control .item {
    background-color: #eef5ff;
    border-radius: 12px;
    padding: 2px 8px;
    margin-right: 4px;
}
.history-chip {
  background: #e7f1ff;
  border: 1px solid #cfe2ff;
  color: #084298;
  padding: 4px 10px;
  border-radius: 16px;
  font-size: 0.8rem;
  display: inline-flex;
  align-items: center;
}
.history-chip button {
  border: none;
  background: transparent;
  margin-left: 6px;
  font-size: 0.9em;
  cursor: pointer;
}
</style>

<form method="post" novalidate>
  {% csrf_token %}

  
  <!-- Always show the card -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light"
             data-bs-toggle="collapse"
             data-bs-target="#pastHistoryCard"
             style="cursor:pointer;">
            <strong>üìú Previous Prescriptions</strong>
            <small class="float-end text-muted">Click to expand</small>
            <span class="float-end small text-muted">
                (Last {{ past_prescriptions|length }})
            </span>
        </div>

        <div id="pastHistoryCard" class="collapse">
            <div class="card-body">

                {% if past_prescriptions %}
                    {% for p in past_prescriptions %}
                    <div class="border-bottom pb-2 mb-2">
                        <strong>{{ p.prescribed_on|date:"d M Y" }}</strong><br>

                        <span class="text-primary">
                            {{ p.diagnosis|default:"No diagnosis recorded" }}
                        </span><br>

                        {% if p.notes_findings %}
                            <small class="text-muted">
                                {{ p.notes_findings|truncatewords:20 }}
                            </small><br>
                        {% endif %}

                        <strong>Medications:</strong>
                        <ul class="small mb-1">
                            {% for d in p.details.all %}
                                <li>{{ d.drug_name }} ‚Äî {{ d.dosage }} ‚Äî {{ d.duration }}</li>
                            {% endfor %}
                        </ul>

                        <button class="btn btn-sm btn-outline-primary copy-meds-btn"
                                data-rx="{{ p.id }}">
                            Copy Medicines ‚Üí
                        </button>

                        <a href="{% url 'prescription:ai_prescription_print_builder' p.id %}" 
                           target="_blank"
                           class="small">
                           View full ‚Üí
                        </a>
                    </div>
                    {% endfor %}

                {% else %}
                    <p class="text-muted small mb-0">
                        No previous prescriptions found for this patient.
                    </p>
                {% endif %}
                

            </div>
        </div>
    </div>
    <!-- End Card -->
  <div class="mb-3">
  
  <!-- Standard Structured History Dropdown -->
  

<select id="std-history-select" multiple placeholder="Search or choose history..." autocomplete="off">
  
  <!-- MEDICAL HISTORY -->
  <optgroup label="Medical History">
    {% for item in std_history.medical_history %}
      <option value="{{ item }}">{{ item }}</option>
    {% endfor %}
  </optgroup>

  <!-- SURGICAL HISTORY -->
  <optgroup label="Surgical History">
    {% for item in std_history.surgical_history %}
      <option value="{{ item }}">{{ item }}</option>
    {% endfor %}
  </optgroup>

  <!-- ALLERGIES -->
  <optgroup label="Allergies">
    {% for item in std_history.allergies %}
      <option value="{{ item }}">{{ item }}</option>
    {% endfor %}
  </optgroup>

  <!-- FAMILY HISTORY -->
  <optgroup label="Family History">
    {% for item in std_history.family_history %}
      <option value="{{ item }}">{{ item }}</option>
    {% endfor %}
  </optgroup>

  <!-- MEDICATION HISTORY -->
  <optgroup label="Medication History">
    {% for item in std_history.medication_history %}
      <option value="{{ item }}">{{ item }}</option>
    {% endfor %}
  </optgroup>

  <!-- SOCIAL HISTORY -->
  <optgroup label="Social History">
    {% for item in std_history.social_history %}
      <option value="{{ item }}">{{ item }}</option>
    {% endfor %}
  </optgroup>

  <!-- RECENT SPECIAL HISTORY -->
  <optgroup label="Recent Special History">
    {% for item in std_history.recent_special_history %}
      <option value="{{ item }}">{{ item }}</option>
    {% endfor %}
  </optgroup>
  <optgroup label="My Custom Templates">
  {% for t in doctor_templates %}
    <option value="{{ t.content }}">{{ t.label }}</option>
  {% endfor %}
      </optgroup>
    </select>
  
    </div>
    {% if draft.data.carried.history %}
    <div class="alert bg-light border p-3 mb-3">
      <strong>Previous History:</strong>
      <pre class="small">{{ draft.data.carried.history }}</pre>
      <button type="button"
              class="btn btn-sm btn-outline-primary"
              onclick="copyToTextarea('id_history', `{{ draft.data.carried.history|escapejs }}`)">
          Copy History ‚Üí
      </button>
    </div>
    {% endif %}

    <!-- Selected History Chips -->
  <div id="history-chips" class="mb-2 d-flex flex-wrap gap-2"></div>

  <textarea
      id="id_history"
      name="history"
      class="form-control"
      rows="8"
      placeholder="E.g. Fever for 3 days, intermittent, associated with chills..."
    >{{ history }}</textarea>

    
  </div>

  <div class="d-flex justify-content-between mt-3">
    <a href="{% url 'doctors:dashboard' %}" class="btn btn-outline-secondary">
      ‚Üê Back to Dashboard
    </a>

    <button type="submit" class="btn btn-primary">
      Next: Symptoms ‚Üí
    </button>
  </div>
  </form>
<div class="modal fade" id="addHistoryTemplateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <form method="post" action="{% url 'prescription:add_history_template' draft.id %}">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title">Add Custom History Template</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <label class="form-label">Template Name</label>
          <input type="text" name="label" class="form-control" required>

          <label class="form-label mt-3">Content</label>
          <textarea name="content" class="form-control" rows="4" required></textarea>

        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Template</button>
        </div>
        <script>
        function copyToTextarea(textareaId, content) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;

            if (textarea.value.trim()) {
                textarea.value += "\n\n" + content.trim();
            } else {
                textarea.value = content.trim();
            }
            textarea.focus();
        }
        </script>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Q0zS8d0qK"
          crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

  <script>
  
  document.addEventListener("DOMContentLoaded", function() {

    const textarea = document.getElementById("id_history");

    

    // ---------------------------
    // TomSelect initialization
    // ---------------------------
    const ts = new TomSelect("#std-history-select", {
      plugins: ["remove_button"],
      persist: false,
      maxItems: null,

      onItemAdd: function(value) {
      const optionEl = this.getOption(value);
      addChip(value);
      if (!optionEl || !optionEl.parentElement) return;
      const group = optionEl.parentElement.label || "History";

      // üü¢ If it is a custom template
      if (group === "My Custom Templates") {
          insertCustomTemplate(value);
          beautifyHistory();
          return;
      }

      // üü¢ Standard history insertion
      ensureSection(group);
      appendToSection(group, value);
      moveCursorToEnd();

    },


    onItemRemove: function(value) {
        const optionEl = this.getOption(value);

        // During page unload, optionEl becomes null ‚Üí prevent crash
        if (!optionEl || !optionEl.parentElement) return;

        const group = optionEl.parentElement.label || "History";
        removeChip(value);
        removeFromSection(group, value);
    }
    });

    function removeChip(label) {
        const chip = document.querySelector(
            `.history-chip[data-value="${CSS.escape(label)}"]`
        );
        if (chip) chip.remove();
    }


    function insertCustomTemplate(value) {
    if (textarea.value.trim()) {
        textarea.value += "\n\n" + value.trim() + "\n";
    } else {
        textarea.value = value.trim() + "\n";
    }
}


    // --------------------------------------
    // Auto-indent and beautify formatting
    // --------------------------------------
    function beautifyHistory() {
      let text = textarea.value;

      text = text.replace(/\n{3,}/g, "\n\n");
      text = text.replace(/:\s*\n+/g, ":\n");
      text = text.replace(/- +/g, "- ");
      text = text.split("\n").map(line => line.trimEnd()).join("\n");

      textarea.value = text;
    }

    // Section helpers
    function ensureSection(section) {
      const s = section + ":";
      if (!textarea.value.includes(s)) {
        if (textarea.value.trim()) {
          textarea.value += "\n\n" + s + "\n";
        } else {
          textarea.value = s + "\n";
        }
      }
    }

    function appendToSection(section, value) {
      const lines = textarea.value.split("\n");
      const result = [];
      lines.forEach(line => {
        result.push(line);
        if (line.trim() === section + ":") {
          result.push("- " + value);
        }
      });
      textarea.value = result.join("\n");
    }
    function moveCursorToEnd() {
        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
        textarea.focus();
    }

    function removeFromSection(section, value) {
      const lines = textarea.value.split("\n");
      const filtered = lines.filter(line => line.trim() !== "- " + value);
      textarea.value = filtered.join("\n");
    }

});
document.addEventListener("DOMContentLoaded", function () {
    Autosave.init();
});
document.getElementById("id_history")
  .addEventListener("input", e => {
      Autosave.save("history", e.target.value);
  });

function addChip(label) {
  const chip = document.createElement("span");
  chip.className = "history-chip";
  chip.dataset.value = label;
  chip.innerHTML = `
    ${label}
    <button type="button" aria-label="Remove">√ó</button>
  `;
  chip.querySelector("button").onclick = () => {
    ts.removeItem(label);
  };
  document.getElementById("history-chips").appendChild(chip);
}

</script>

{% endblock %}