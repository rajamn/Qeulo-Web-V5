{% extends 'base.html' %}
{% load core_filters %}

{% block title %}
  Patient Self-Registration - {{ hospital.hospital_name }}
{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 900px;">
  <!-- ðŸ¥ Hospital Header -->
  <div class="text-center mb-4">
    <h2 class="text-primary">{{ hospital.hospital_name }}</h2>
    <p class="text-muted">Patient Self Check-In</p>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show text-center" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- ðŸ’³ Registration Form -->
  <form method="post" class="card p-4 shadow-sm bg-white border-0 rounded-3">
    {% csrf_token %}
    <input type="hidden" name="payment-paid_on" id="id_payment-paid_on">

    <div class="row">
      <!-- Left: Contact + Demographics -->
      <div class="col-md-6">
        <h5 class="text-secondary mb-3">Patient Info</h5>

        <div class="mb-3">
          {{ patient_form.mobile_num.label_tag }}
          {{ patient_form.mobile_num|add_attr:"class=form-control autocomplete=off placeholder='Enter mobile number' autofocus" }}
        </div>

        <div class="mb-3">
          {{ patient_form.contact_name.label_tag }}
          {{ patient_form.contact_name|add_attr:"class=form-control id=contact_name placeholder='Enter contact name'" }}
        </div>

        <div class="mb-3 d-flex align-items-end gap-3">
          <div class="flex-grow-1">
            {{ patient_form.patient_name.label_tag }}
            {{ patient_form.patient_name|add_attr:"class=form-control id=patient_name placeholder='Enter patient name'" }}
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="same_as_contact">
            <label class="form-check-label" for="same_as_contact">Same?</label>
          </div>
        </div>

        <div class="mb-3">
          {{ patient_form.age_years.label_tag }}
          {{ patient_form.age_years|add_attr:"class=form-control placeholder='Years'" }}
        </div>

        <div class="mb-3">
          {{ patient_form.age_months.label_tag }}
          {{ patient_form.age_months|add_attr:"class=form-control placeholder='Months'" }}
        </div>

        <div class="mb-3">
          {{ patient_form.gender.label_tag }}
          {{ patient_form.gender|add_attr:"class=form-select" }}
        </div>

        <div class="mb-3">
          {{ patient_form.referred_by.label_tag }}
          {{ patient_form.referred_by|add_attr:"class=form-control placeholder='Optional'" }}
        </div>
      </div>

      <!-- Right: Doctor + Billing -->
      <div class="col-md-6">
        <h5 class="text-secondary mb-3">Appointment & Billing</h5>

        <div class="mb-3">
          {{ appointment_form.doctor.label_tag }}
          {{ appointment_form.doctor|add_attr:"class=form-select" }}
        </div>

        <div class="mb-3">
          {{ appointment_form.appointment_on.label_tag }}
          {{ appointment_form.appointment_on|add_attr:"class=form-control" }}
        </div>

        <h6 class="text-secondary mt-4">Billing Details</h6>
        <div class="row border rounded p-3 mb-3 bg-light shadow-sm">
          <div class="col-md-4">
            {{ transaction_form.service.label_tag }}
            {{ transaction_form.service|add_attr:"class=form-select" }}
          </div>
          <div class="col-md-4">
            {{ transaction_form.pay_type.label_tag }}
            {{ transaction_form.pay_type|add_attr:"class=form-select" }}
          </div>
          <div class="col-md-4">
            {{ transaction_form.amount.label_tag }}
            {{ transaction_form.amount|add_attr:"class=form-control amount-field" }}
          </div>
        </div>

        <!-- âœ… Total Amount Display -->
        <div class="mb-3 text-end">
          <strong>Total Amount: â‚¹
            <span id="total_amount">
              {{ total_amount|default:consultation_fee|default:"0.00" }}
            </span>
          </strong>
        </div>
        <!-- ðŸ’° Live ETA & Total Display -->
        <div class="mt-4 border rounded p-3 bg-light shadow-sm">
          <div class="row text-center">
            <div class="col-md-6">
              <h6 class="text-secondary mb-1">Estimated Time</h6>
              <div id="eta-display" class="fs-5 text-primary fw-bold">â€”</div>
            </div>
            <div class="col-md-6">
              <h6 class="text-secondary mb-1">Total Amount</h6>
              <div id="total_amount_display" class="fs-5 text-success fw-bold">
                â‚¹ {{ total_amount|default:consultation_fee|default:"0.00" }}
              </div>
            </div>
          </div>
        </div>
        <div class="text-center mt-4">
          <button type="submit" name="submit" class="btn btn-primary px-5 py-2">
            Register
          </button>
        </div>
      </div>
    </div>
  </form>

  <!-- ðŸ” ETA Display -->
  {% if eta %}
    <div class="alert alert-info mt-3 text-center">
      <strong>Estimated Time of Appointment (ETA):</strong>
      {{ eta|time:"H:i" }}
      {% if que_pos %}
        <span class="text-muted ms-2">(Queue Position: {{ que_pos }})</span>
      {% endif %}
      <!-- ðŸ•’ ETA placeholder (for JS updates) -->
      <div id="eta-display" class="alert alert-info mt-3 text-center d-none"></div>
    </div>
  {% endif %}
</div>

<!-- âœ… Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const $ = (id) => document.getElementById(id);
  const contactIdTpl = "{{ patient_form.contact_name.id_for_label }}";
  const patientIdTpl = "{{ patient_form.patient_name.id_for_label }}";

  const contactInput =
    $("contact_name") || (contactIdTpl ? $(contactIdTpl) : null);
  const patientInput =
    $("patient_name") || (patientIdTpl ? $(patientIdTpl) : null);
  const checkbox = $("same_as_contact");

  function copyIfChecked() {
    if (checkbox && checkbox.checked && contactInput && patientInput) {
      patientInput.value = contactInput.value || "";
    }
  }

  if (checkbox && contactInput && patientInput) {
    // Initial copy if user reloads with checkbox already checked
    copyIfChecked();

    // Toggle behavior
    checkbox.addEventListener("change", () => {
      copyIfChecked();
      // Optional: lock/unlock patient field while â€œSame?â€ is on
      patientInput.readOnly = checkbox.checked;
    });

    // Keep copying as user types the contact name
    contactInput.addEventListener("input", copyIfChecked);
  }
});

  // 2) Total billing amount
  const totalSpan = document.getElementById("total_amount");
  document.querySelectorAll(".amount-field").forEach(input => {
    input.addEventListener("input", () => {
      let total = 0;
      document.querySelectorAll(".amount-field").forEach(i => {
        const val = parseFloat(i.value);
        if (!isNaN(val)) total += val;
      });
      totalSpan.textContent = total.toFixed(2);
    });
  });


  // 3) ETA fetch (simple guard)
  const doctorSelect = document.getElementById("id_appointment-doctor");
  const etaContainer = document.getElementById("eta-display");
  const apptDate = document.getElementById("id_appointment-appointment_on");
  const payDate = document.getElementById("id_payment-paid_on");


  if (doctorSelect && etaContainer) {
    doctorSelect.addEventListener("change", function () {
      const doctorIdVal = this.value;
      etaContainer.innerHTML = "<em>Updating...</em>";

      if (doctorIdVal) {
        fetch("{% url 'patients:get_eta' %}?doctor_id=" + encodeURIComponent(doctorIdVal))
          .then(r => (r.ok ? r.json() : Promise.reject()))
          .then(data => {
            etaContainer.innerHTML =
              data.eta
                ? `<strong>Estimated Time of Appointment (ETA):</strong> ${data.eta}`
                : "<em>Unavailable</em>";
          })
          .catch(() => {
            etaContainer.innerHTML = "<em>Unavailable</em>";
          });
      } else {
        etaContainer.innerHTML = "<em>--</em>";
      }
    });
  }

  // 4) Sync appointment date â†’ hidden paid_on
  if (apptDate && payDate) {
    const syncPayDate = () => { payDate.value = apptDate.value; };
    syncPayDate();
    apptDate.addEventListener("change", syncPayDate);

    // Reset button should re-sync after native reset completes
    const form = apptDate.closest("form");
    if (form) {
      form.addEventListener("reset", () => {
        // Allow browser to reset first
        setTimeout(syncPayDate, 0);
      });

      // Optional: prevent double submits
      form.addEventListener("submit", () => {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.dataset.originalText = submitBtn.textContent;
          submitBtn.textContent = "Savingâ€¦";
        }
      });
    }
  }

  // 5) Readonly mobile in edit mode
  const isEdit = "{{ is_edit|yesno:'true,false' }}";
  if (isEdit === "true" && mobileInput) {
    mobileInput.readOnly = true;
  }

</script>
{% endblock %}
