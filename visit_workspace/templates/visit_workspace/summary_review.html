{% extends "base_sidebar.html" %}
{% load static %}

{% block title %}Review Summary{% endblock %}

{% block content %}
<div class="container mt-4">

  <h3 class="text-primary mb-4">
    <i class="bi bi-columns-gap"></i> Document Review
  </h3>

  <!-- Patient -->
  <div class="mb-4">
    <h5>
      <i class="bi bi-person"></i>
      {{ patient.patient_name }} â€” {{ patient.contact.mobile_num }}
    </h5>
  </div>

  <div class="row g-4">

    <!-- Column 1: OCR TEXT -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">
          <i class="bi bi-file-text"></i> OCR Extracted Text
        </div>
        <div class="card-body" style="max-height: 70vh; overflow-y: auto;">
          <pre style="white-space: pre-wrap;">{{ ocr_text }}</pre>
        </div>
      </div>
    </div>

    <!-- Column 2: AI SUMMARY -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-robot"></i> AI Summary
        </div>

        <div class="card-body" style="max-height: 70vh; overflow-y: auto;">

          {% if summary.key_findings %}
          <h6 class="fw-bold mt-3">Key Findings</h6>
          <p>{{ summary.key_findings }}</p>
          {% endif %}

          {% if summary.impression %}
          <h6 class="fw-bold mt-3">Impression</h6>
          <p>{{ summary.impression }}</p>
          {% endif %}

          {% if summary.recommendations %}
          <h6 class="fw-bold mt-3">Recommendations</h6>
          <p>{{ summary.recommendations }}</p>
          {% endif %}

          {% if summary.free_summary %}
          <h6 class="fw-bold mt-3">Summary (Text)</h6>
          <textarea id="editableSummary" class="form-control" rows="8">{{ summary.free_summary }}</textarea>
          {% endif %}

        </div>
      </div>

      <!-- ACTION BUTTONS -->
      <div class="mt-3 d-flex gap-2">
        <button id="approveBtn" class="btn btn-success">
          <i class="bi bi-check2-circle"></i> Approve
        </button>

        <button id="rejectBtn" class="btn btn-danger">
          <i class="bi bi-x-circle"></i> Reject
        </button>
      </div>
    </div>

    <!-- Column 3: Extracted Lab Values -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <i class="bi bi-table"></i> Structured Data
        </div>

        <div class="card-body" style="max-height: 70vh; overflow-y: auto;">

          {% if summary.structured_values %}
          <table class="table table-bordered table-sm">
            <thead class="table-light">
              <tr>
                <th>Test</th>
                <th>Value</th>
                <th>Range</th>
              </tr>
            </thead>
            <tbody>
              {% for row in summary.structured_values %}
              <tr>
                <td>{{ row.test }}</td>
                <td>{{ row.value }}</td>
                <td>{{ row.range }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="text-muted">No structured values extracted.</p>
          {% endif %}

        </div>
      </div>
    </div>

  </div>

</div>

<script>
document.getElementById("approveBtn").onclick = async () => {
  await fetch("{% url 'visit_workspace:approve_summary' doc.id %}", {
    method: "POST",
    headers: { "X-CSRFToken": "{{ csrf_token }}" },
  });
  alert("Summary approved!");
  window.location.href = "{% url 'visit_workspace:patient_history' patient.id %}";
};

document.getElementById("rejectBtn").onclick = async () => {
  await fetch("{% url 'visit_workspace:reject_summary' doc.id %}", {
    method: "POST",
    headers: { "X-CSRFToken": "{{ csrf_token }}" },
  });
  alert("Summary rejected.");
  window.location.href = "{% url 'visit_workspace:patient_history' patient.id %}";
};
</script>

{% endblock %}
